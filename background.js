/*! For license information please see background.js.LICENSE.txt */
(()=>{"use strict";const t=function(){return new Promise((function(t,e){try{chrome.storage.local.get("feedSource",(function(e){var n=e.feedSource;t(n||2)}))}catch(t){e(t)}}))},e=function(){return new Promise((function(t,e){try{chrome.storage.local.get("fetchInterval",(function(e){var n=e.fetchInterval;t(n||1)}))}catch(t){e(t)}}))},n=function(){return new Promise((function(t,e){try{chrome.storage.local.get(["playNotificationSound"],(function(e){var n=e.playNotificationSound;t(n||!1)}))}catch(t){e(t)}}))},r=function(t){"undefined"!=typeof window&&window.localStorage&&localStorage.setItem("playNotificationSound",JSON.stringify(t)),chrome.storage.local.set({playNotificationSound:t})},o=function(){return new Promise((function(t,e){try{chrome.storage.local.get(["isFetchingEnabled"],(function(e){var n=e.isFetchingEnabled;t(0!=n||n)}))}catch(t){e(t)}}))},i=function(t){"undefined"!=typeof window&&window.localStorage&&localStorage.setItem("isFetchingEnabled",JSON.stringify(t)),chrome.storage.local.set({isFetchingEnabled:t})};function a(t){return function(t){if(Array.isArray(t))return c(t)}(t)||function(t){if("undefined"!=typeof Symbol&&null!=t[Symbol.iterator]||null!=t["@@iterator"])return Array.from(t)}(t)||function(t,e){if(t){if("string"==typeof t)return c(t,e);var n={}.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?c(t,e):void 0}}(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function c(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,r=Array(e);n<e;n++)r[n]=t[n];return r}function s(t){return 0==t.isRead}const u=function(t){return new Promise((function(e,n){try{chrome.storage.local.get("jobs").then((function(n){var r=n.jobs;r=r||[];var o=(t=t||[]).filter((function(t){return!r.some((function(e){return n=t,e.ciphertext==n.ciphertext;var n}))}));o.forEach((function(t){t.isRead=!1,t.isFresh=!0})),r.forEach((function(t){t.isFresh=!1})),console.log("newJobs:"+o.length),console.log("jobs:"+r.length);var i=[].concat(a(o),a(r));chrome.storage.local.set({jobs:i}),e(o)})).catch((function(t){return console.error(t)}))}catch(t){n(t)}}))},l=function(){return new Promise((function(t,e){chrome.storage.local.get(["jobs"]).then((function(e){var n=e.jobs;if(n){var r=n.filter(s);t(r)}else t(n=[])})).catch((function(t){return e(t)}))}))},f=function(){chrome.storage.local.get(["jobs"],(function(t){var e=t.jobs;e&&e.length>30&&(e=e.slice(0,30),chrome.storage.local.set({jobs:e}))}))};var h={counter:0,getText:function(t){chrome.action.getBadgeText({},t)},refresh:function(){chrome.action.setBadgeText({text:""}),this.counter=0},setCounter:function(t){this.counter=t,chrome.action.setBadgeText({text:0===t?"":t.toString()})},increment:function(){this.counter+=1,chrome.action.setBadgeText({text:this.counter.toString()})},decrement:function(){this.counter>0&&(this.counter-=1),chrome.action.setBadgeText({text:0===this.counter?"":this.counter.toString()})},increaseBy:function(t){this.counter+=t,chrome.action.setBadgeText({text:this.counter.toString()})},setText:function(t){chrome.action.setBadgeText({text:t})}};chrome.action.setBadgeBackgroundColor({color:"#f44e42"});const p=h,m=[{query:"query($limit: Int, $toTime: String) {\n        mostRecentJobsFeed(limit: $limit, toTime: $toTime) {\n          results {\n            id,\n            uid:id\n            title,\n            ciphertext,\n            description,\n            type,\n            recno,\n            freelancersToHire,\n            duration,\n            engagement,\n            amount {\n              amount,\n            },\n            createdOn:createdDateTime,\n            publishedOn:publishedDateTime,\n            prefFreelancerLocationMandatory,\n            connectPrice,\n            client {\n              totalHires\n              totalSpent\n              paymentVerificationStatus,\n              location {\n                country,\n              },\n              totalReviews\n              totalFeedback,\n              hasFinancialPrivacy\n            },\n            tierText\n            tier\n            tierLabel\n            proposalsTier\n            enterpriseJob\n            premium,\n            jobTs:jobTime,\n            attrs:skills {\n              id,\n              uid:id,\n              prettyName:prefLabel\n              prefLabel\n            }\n            hourlyBudget {\n              type\n              min\n              max\n            }\n            isApplied\n          },\n          paging {\n            total,\n            count,\n            resultSetTs:minTime,\n            maxTime\n          }\n        }\n      }",variables:{limit:10}},{query:"\n          query($queryParams: UserSavedSearchesParams) {\n            userSavedSearches(params: $queryParams) {\n              results {\n                id\n                uid:id\n                title\n                ciphertext\n                description\n                type\n                recno\n                freelancersToHire\n                duration\n                durationLabel\n                engagement\n                amount {\n                  amount:displayValue\n                }\n                createdOn:createdDateTime\n                publishedOn:publishedDateTime\n                renewedOn:renewedDateTime\n                prefFreelancerLocation\n                prefFreelancerLocationMandatory\n                connectPrice\n                client {\n                  totalHires\n                  totalPostedJobs\n                  totalSpent {\n                    rawValue\n                    currency\n                    displayValue\n                  }\n                  paymentVerificationStatus,\n                  location {\n                    country\n                  }\n                  totalReviews\n                  totalFeedback\n                  companyRid\n                  edcUserId\n                  lastContractRid\n                  companyOrgUid\n                  hasFinancialPrivacy\n                }\n                enterpriseJob\n                premium\n                jobTs:jobTime\n                skills {\n                  id\n                  name\n                  prettyName\n                  highlighted\n                }\n                contractorTier\n                jobStatus\n                relevanceEncoded\n                totalApplicants\n                proposalsTier\n                isLocal:local\n                locations {\n                  city\n                  country\n                }\n                isApplied:applied\n                attrs {\n                  id\n                  uid:id\n                  prettyName:prefLabel\n                  parentSkillId\n                  prefLabel\n                  highlighted\n                  freeText\n                }\n                hourlyBudget {\n                  type\n                  min\n                  max\n                }\n                clientRelation {\n                  companyRid\n                  companyName\n                  edcUserId\n                  lastContractPlatform\n                  lastContractRid\n                  lastContractTitle\n                }\n                totalFreelancersToHire\n                contractToHire\n              }\n              paging {\n                  total\n                  count\n                  resultSetTs:resultSetTime\n              }\n            }\n          }\n        ",variables:{queryParams:{}}},{query:"\n      query bestMatches ($fromTime: String!, $toTime: String!) {\n          bestMatchJobsFeed(fromTime: $fromTime, toTime: $toTime) {\n            results {\n              uid:id\n              title\n              ciphertext\n              description\n              type\n              recno\n              freelancersToHire\n              duration\n              durationLabel\n              engagement\n              amount {\n                amount\n                currencyCode\n              }\n              createdOn:createdDateTime\n              publishedOn:publishedDateTime\n              renewedOn:renewedDateTime\n              prefFreelancerLocation\n              prefFreelancerLocationMandatory\n              connectPrice\n              client {\n                totalHires\n                totalSpent\n                paymentVerificationStatus\n                location {\n                  country\n                  city\n                  state\n                  countryTimezone\n                  worldRegion\n                }\n                totalReviews\n                totalFeedback\n                hasFinancialPrivacy\n              }\n              enterpriseJob\n              premium\n              jobTime\n              skills {\n                id\n                prefLabel\n              }\n              tierText\n              tier\n              tierLabel\n              proposalsTier\n              isApplied\n              hourlyBudget {\n                type\n                min\n                max\n              }\n              weeklyBudget {\n                amount\n              }\n              clientRelation {\n                companyName\n                lastContractRid\n                lastContractTitle\n              }\n              relevanceEncoded\n              attrs {\n                uid:id\n                prettyName\n                freeText\n                skillType\n              }\n            }\n            paging {\n              total\n              count\n              minTime\n              maxTime\n            }\n          }\n        }",variables:{fromTime:0,toTime:30}}];function d(t){return d="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},d(t)}function y(){y=function(){return e};var t,e={},n=Object.prototype,r=n.hasOwnProperty,o=Object.defineProperty||function(t,e,n){t[e]=n.value},i="function"==typeof Symbol?Symbol:{},a=i.iterator||"@@iterator",c=i.asyncIterator||"@@asyncIterator",s=i.toStringTag||"@@toStringTag";function u(t,e,n){return Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}),t[e]}try{u({},"")}catch(t){u=function(t,e,n){return t[e]=n}}function l(t,e,n,r){var i=e&&e.prototype instanceof b?e:b,a=Object.create(i.prototype),c=new A(r||[]);return o(a,"_invoke",{value:E(t,n,c)}),a}function f(t,e,n){try{return{type:"normal",arg:t.call(e,n)}}catch(t){return{type:"throw",arg:t}}}e.wrap=l;var h="suspendedStart",p="suspendedYield",m="executing",g="completed",v={};function b(){}function w(){}function x(){}var T={};u(T,a,(function(){return this}));var S=Object.getPrototypeOf,L=S&&S(S(I([])));L&&L!==n&&r.call(L,a)&&(T=L);var k=x.prototype=b.prototype=Object.create(T);function j(t){["next","throw","return"].forEach((function(e){u(t,e,(function(t){return this._invoke(e,t)}))}))}function O(t,e){function n(o,i,a,c){var s=f(t[o],t,i);if("throw"!==s.type){var u=s.arg,l=u.value;return l&&"object"==d(l)&&r.call(l,"__await")?e.resolve(l.__await).then((function(t){n("next",t,a,c)}),(function(t){n("throw",t,a,c)})):e.resolve(l).then((function(t){u.value=t,a(u)}),(function(t){return n("throw",t,a,c)}))}c(s.arg)}var i;o(this,"_invoke",{value:function(t,r){function o(){return new e((function(e,o){n(t,r,e,o)}))}return i=i?i.then(o,o):o()}})}function E(e,n,r){var o=h;return function(i,a){if(o===m)throw Error("Generator is already running");if(o===g){if("throw"===i)throw a;return{value:t,done:!0}}for(r.method=i,r.arg=a;;){var c=r.delegate;if(c){var s=P(c,r);if(s){if(s===v)continue;return s}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if(o===h)throw o=g,r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);o=m;var u=f(e,n,r);if("normal"===u.type){if(o=r.done?g:p,u.arg===v)continue;return{value:u.arg,done:r.done}}"throw"===u.type&&(o=g,r.method="throw",r.arg=u.arg)}}}function P(e,n){var r=n.method,o=e.iterator[r];if(o===t)return n.delegate=null,"throw"===r&&e.iterator.return&&(n.method="return",n.arg=t,P(e,n),"throw"===n.method)||"return"!==r&&(n.method="throw",n.arg=new TypeError("The iterator does not provide a '"+r+"' method")),v;var i=f(o,e.iterator,n.arg);if("throw"===i.type)return n.method="throw",n.arg=i.arg,n.delegate=null,v;var a=i.arg;return a?a.done?(n[e.resultName]=a.value,n.next=e.nextLoc,"return"!==n.method&&(n.method="next",n.arg=t),n.delegate=null,v):a:(n.method="throw",n.arg=new TypeError("iterator result is not an object"),n.delegate=null,v)}function F(t){var e={tryLoc:t[0]};1 in t&&(e.catchLoc=t[1]),2 in t&&(e.finallyLoc=t[2],e.afterLoc=t[3]),this.tryEntries.push(e)}function N(t){var e=t.completion||{};e.type="normal",delete e.arg,t.completion=e}function A(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(F,this),this.reset(!0)}function I(e){if(e||""===e){var n=e[a];if(n)return n.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var o=-1,i=function n(){for(;++o<e.length;)if(r.call(e,o))return n.value=e[o],n.done=!1,n;return n.value=t,n.done=!0,n};return i.next=i}}throw new TypeError(d(e)+" is not iterable")}return w.prototype=x,o(k,"constructor",{value:x,configurable:!0}),o(x,"constructor",{value:w,configurable:!0}),w.displayName=u(x,s,"GeneratorFunction"),e.isGeneratorFunction=function(t){var e="function"==typeof t&&t.constructor;return!!e&&(e===w||"GeneratorFunction"===(e.displayName||e.name))},e.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,x):(t.__proto__=x,u(t,s,"GeneratorFunction")),t.prototype=Object.create(k),t},e.awrap=function(t){return{__await:t}},j(O.prototype),u(O.prototype,c,(function(){return this})),e.AsyncIterator=O,e.async=function(t,n,r,o,i){void 0===i&&(i=Promise);var a=new O(l(t,n,r,o),i);return e.isGeneratorFunction(n)?a:a.next().then((function(t){return t.done?t.value:a.next()}))},j(k),u(k,s,"Generator"),u(k,a,(function(){return this})),u(k,"toString",(function(){return"[object Generator]"})),e.keys=function(t){var e=Object(t),n=[];for(var r in e)n.push(r);return n.reverse(),function t(){for(;n.length;){var r=n.pop();if(r in e)return t.value=r,t.done=!1,t}return t.done=!0,t}},e.values=I,A.prototype={constructor:A,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=t,this.done=!1,this.delegate=null,this.method="next",this.arg=t,this.tryEntries.forEach(N),!e)for(var n in this)"t"===n.charAt(0)&&r.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=t)},stop:function(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var n=this;function o(r,o){return c.type="throw",c.arg=e,n.next=r,o&&(n.method="next",n.arg=t),!!o}for(var i=this.tryEntries.length-1;i>=0;--i){var a=this.tryEntries[i],c=a.completion;if("root"===a.tryLoc)return o("end");if(a.tryLoc<=this.prev){var s=r.call(a,"catchLoc"),u=r.call(a,"finallyLoc");if(s&&u){if(this.prev<a.catchLoc)return o(a.catchLoc,!0);if(this.prev<a.finallyLoc)return o(a.finallyLoc)}else if(s){if(this.prev<a.catchLoc)return o(a.catchLoc,!0)}else{if(!u)throw Error("try statement without catch or finally");if(this.prev<a.finallyLoc)return o(a.finallyLoc)}}}},abrupt:function(t,e){for(var n=this.tryEntries.length-1;n>=0;--n){var o=this.tryEntries[n];if(o.tryLoc<=this.prev&&r.call(o,"finallyLoc")&&this.prev<o.finallyLoc){var i=o;break}}i&&("break"===t||"continue"===t)&&i.tryLoc<=e&&e<=i.finallyLoc&&(i=null);var a=i?i.completion:{};return a.type=t,a.arg=e,i?(this.method="next",this.next=i.finallyLoc,v):this.complete(a)},complete:function(t,e){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&e&&(this.next=e),v},finish:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var n=this.tryEntries[e];if(n.finallyLoc===t)return this.complete(n.completion,n.afterLoc),N(n),v}},catch:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var n=this.tryEntries[e];if(n.tryLoc===t){var r=n.completion;if("throw"===r.type){var o=r.arg;N(n)}return o}}throw Error("illegal catch attempt")},delegateYield:function(e,n,r){return this.delegate={iterator:I(e),resultName:n,nextLoc:r},"next"===this.method&&(this.arg=t),v}},e}function g(t,e,n,r,o,i,a){try{var c=t[i](a),s=c.value}catch(t){return void n(t)}c.done?e(s):Promise.resolve(s).then(r,o)}function v(t){return function(){var e=this,n=arguments;return new Promise((function(r,o){var i=t.apply(e,n);function a(t){g(i,r,o,a,c,"next",t)}function c(t){g(i,r,o,a,c,"throw",t)}a(void 0)}))}}var b=0,w=[],x=[];function T(){return S.apply(this,arguments)}function S(){return S=v(y().mark((function t(){var e,n,r=arguments;return y().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return e=r.length>0&&void 0!==r[0]?r[0]:"notification.mp3",n=r.length>1&&void 0!==r[1]?r[1]:1,t.prev=2,t.next=5,L();case 5:t.next=11;break;case 7:if(t.prev=7,t.t0=t.catch(2),t.t0.message.startsWith("Only a single offscreen")){t.next=11;break}throw t.t0;case 11:return t.next=13,chrome.runtime.sendMessage({play:{source:e,volume:n}});case 13:case"end":return t.stop()}}),t,null,[[2,7]])}))),S.apply(this,arguments)}function L(){return k.apply(this,arguments)}function k(){return(k=v(y().mark((function t(){return y().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,chrome.offscreen.hasDocument();case 2:if(!t.sent){t.next=4;break}return t.abrupt("return");case 4:return t.next=6,chrome.offscreen.createDocument({url:"offscreen.html",reasons:[chrome.offscreen.Reason.AUDIO_PLAYBACK],justification:"testing"});case 6:case"end":return t.stop()}}),t)})))).apply(this,arguments)}function j(t){return O.apply(this,arguments)}function O(){return(O=v(y().mark((function t(e){return y().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,chrome.cookies.getAll({path:e});case 2:return t.abrupt("return",t.sent);case 3:case"end":return t.stop()}}),t)})))).apply(this,arguments)}var E=function(){var e=v(y().mark((function e(){var r,o,i,a,c,s,f,h;return y().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,j("/nx/find-work/");case 2:return e.sent.forEach((function(t){t.value&&t.value.startsWith("oauth2v2_")&&(w.push(t.value),x.push(t.name))})),w.length>0?chrome.storage.local.set({auth:!0}):chrome.storage.local.set({auth:!1}),e.next=7,t();case 7:return r=e.sent,e.next=10,fetch("https://www.upwork.com/api/graphql/v1",{method:"POST",headers:{Authorization:"bearer "+(w[1]||w[0]),"Content-Type":"application/json"},body:JSON.stringify(m[r])});case 10:return o=e.sent,e.next=13,o.json();case 13:for(c in i=e.sent,a=null==i?void 0:i.data)a.hasOwnProperty(c)&&(a=null===(s=a[c])||void 0===s?void 0:s.results);return a||((x[1]||x[0])&&(chrome.cookies.remove({url:"https://www.upwork.com/nx/find-work/",name:x[1]||x[0]}),console.log("chrome.cookies.remove")),chrome.tabs.create({url:"https://www.upwork.com/nx/find-work/"})),e.next=19,u(a);case 19:return f=e.sent,e.next=22,l();case 22:if(h=e.sent,p.setCounter(h.length),chrome.storage.local.set({auth:!0}),!(f.length>0)){e.next=33;break}return P.removeOldNotifications(),chrome.notifications.create("freshJobs-"+ ++b,{type:"basic",iconUrl:"./notification-icon.png",title:"You got "+f.length+" new jobs!",message:"Don't miss your chance",buttons:[{title:"Click here to take a look"}]}),e.next=30,n();case 30:if(e.t0=e.sent,0==e.t0){e.next=33;break}T("notification.mp3",1);case 33:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),P={removeOldNotifications:function(){return v(y().mark((function t(){return y().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",new Promise((function(t,e){try{chrome.notifications.getAll((function(e){for(var n in e){if("freshJobs"!==(n+"").substr(0,9))return;e.hasOwnProperty(n)&&chrome.notifications.clear(n)}t()}))}catch(t){e(t)}})));case 1:case"end":return t.stop()}}),t)})))()}};const F=function(t){chrome.alarms.create("jobsFetch",{periodInMinutes:t})};chrome.action.onClicked.addListener((function(){chrome.tabs.create({url:"/index.html"})})),chrome.runtime.onInstalled.addListener((function(){chrome.tabs.create({url:"/index.html"})})),o().then((function(t){0!=t&&1!=t&&(t=!0,i(!0),r(!0)),0!=t&&e().then((function(t){F(t),E()}))})),chrome.alarms.onAlarm.addListener((function(t){t.name,f(),E()})),chrome.notifications.onButtonClicked.addListener((function(t){"freshJobs"===(t+"").substr(0,9)&&(chrome.tabs.create({url:"/index.html"}),chrome.notifications.clear(t))}))})();